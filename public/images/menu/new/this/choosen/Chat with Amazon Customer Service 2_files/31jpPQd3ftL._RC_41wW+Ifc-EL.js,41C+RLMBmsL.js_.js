(function(){var f=function(e){(function(c){"undefined"==typeof amzn&&(amzn={});"undefined"==typeof amzn.c2c&&(amzn.c2c={});var f="pdf jpg gif png doc docx jpeg xls xlsx txt csv odt rtf".split(" "),g={test:{na:"https://c2c.integ.amazon.com",fe:"https://c2c-fe.integ.amazon.com",eu:"https://c2c-eu.integ.amazon.com",cn:"https://c2c-cn.integ.amazon.com"},master:{na:"https://c2c-preprod.amazon.com",fe:"https://c2c-fe-preprod.amazon.com",eu:"https://c2c-eu-preprod.amazon.com",cn:"https://c2c-cn-preprod.amazon.com"},
prod:{na:"https://c2c.amazon.com",fe:"https://c2c-fe.amazon.com",eu:"https://c2c-eu.amazon.com",cn:"https://c2c.amazon.cn"}};amzn.c2c.AttachmentUploader=function(a,b){this._uploadCounter=0;this._attachmentIds={};this._uploadStatusPollCounter=0;this._xhrRequests={};this.options=c.extend({notifyUploadComplete:function(){},isDisplayUploadedFile:!0,divIdPrefix:"",chatId:"",serviceEnv:"test",serviceGeo:"na"},a);this._attachmentStrings=c.extend({attachFile:"Send file",fleErrorMessage:"The selected file has exceeded the maximum File Size Limit 10MB",
serviceFailureMessage:"Oops! We are having trouble in processing your request",networkFailureMessage:"unable to process your request please verify your network connectivity",malwareDetected:"Virus is detected in file that you are uploading. Upload will be canceled.",invalidFileFormat:"Invalid file format for file",failedToUpload:"Failed to upload file",cancelAttachment:"X"},a.strings);this._container=b;this._log=amzn.cs.log.getLogger("attachment-uploader");this._divIds={attachmentLinkId:this.options.divIdPrefix+
"attachment-link",attachmentFileSelectorId:this.options.divIdPrefix+"attachment-file-selector",attachmentProgressBarsId:this.options.divIdPrefix+"attachment-progressbars",attachmentProgressBarId:this.options.divIdPrefix+"attachment-progressbar_",attachmentUploadProgressId:this.options.divIdPrefix+"attachment-uploadprogress_",uploadForm:this.options.divIdPrefix+"uploadForm",submitButton:this.options.divIdPrefix+"submit",cancelButton:this.options.divIdPrefix+"attachment-cancel_",uploadIframe:this.options.divIdPrefix+
"uploadIframe"};this._pollingSemaphore=0;this._template="<div class='attachment-upload-widget'><div id="+this._divIds.attachmentProgressBarsId+"/><div class= 'attachment-filechooser'><a style='text-decoration:underline' id="+this._divIds.attachmentLinkId+" href='javascript: void(0)' >"+this._attachmentStrings.attachFile+"</a><form id="+this._divIds.uploadForm+" method='POST' style='display:none;' enctype='multipart/form-data' name='uploadForm' action='' target='"+this._divIds.uploadIframe+"'>   <input  id='"+
this._divIds.attachmentFileSelectorId+"' name='fileStream' size='200' type='file'>  <input class='submit' value='Submit' type='submit' id="+this._divIds.submitButton+" > </form><iframe id='"+this._divIds.uploadIframe+"' name='"+this._divIds.uploadIframe+"' src='JavaScript:'';' style='display:none;' onLoad=''></div></div>";c(this._container).html(this._template);this._setupFileSelector()};amzn.c2c.AttachmentUploader.prototype.getUploadUrlSuccess=function(a){var b=this;b.uploadUrl=a.uploadUrl;b.pollUrl=
a.pollUrl;b._currentAttachmentId=a.aid;c("#"+this._divIds.uploadForm).attr("action",b.uploadUrl);c("#"+this._divIds.uploadForm).submit();c("#"+this._divIds.submitButton).click();c("#"+b._divIds.attachmentProgressBarId+b._uploadCounter).val(40);c("#"+b._divIds.uploadIframe).load(function(){!0===b._pollingNeeded&&b.startPolling(b._uploadCounter)})};amzn.c2c.AttachmentUploader.prototype.startPolling=function(a){var b=this;this._clockInterval&&this.stopPolling();this._uploadStatusPollCounter=0;a=c("#"+
b._divIds.attachmentProgressBarId+b._uploadCounter)[0].value;70>a&&c("#"+b._divIds.attachmentProgressBarId+b._uploadCounter).val(a+10);this._clockInterval=window.setInterval(function(){return b.getUploadStatus.apply(b,[])},100)};amzn.c2c.AttachmentUploader.prototype.stopPolling=function(){this._clockInterval&&window.clearInterval(this._clockInterval)};amzn.c2c.AttachmentUploader.prototype._postPollRequest=function(){!1===this.options.isDisplayUploadedFile&&c("#"+this._divIds.attachmentUploadProgressId+
this._uploadCounter).remove();this.stopPolling()};amzn.c2c.AttachmentUploader.prototype._postPollRequestSuccess=function(){!1===this.options.isDisplayUploadedFile&&c("#"+this._divIds.attachmentUploadProgressId+this._uploadCounter).remove();this.showUploadDiv();this.stopPolling()};amzn.c2c.AttachmentUploader.prototype.getUploadStatus=function(){var a=this;1!==a._pollingSemaphore&&(this._uploadStatusPollCounter++,100<this._uploadStatusPollCounter&&(a._postPollRequest(),c("#"+a._divIds.attachmentProgressBarsId).append(a._getErrorMessageHtml(a._attachmentStrings.failedToUpload)),
a._log.error("Upload status poll requests breached Maximum limit. Polling aborted"),a._bindRemoveClickEvent(),a._pollingSemaphore=0),a._pollingSemaphore=1,e.ajax({url:this.pollUrl,success:function(b){b=e(b).find("status").text();if("SUCCESS"===b)a._postPollRequestSuccess(),a.options.notifyUploadComplete&&c.isFunction(a.options.notifyUploadComplete)&&(a.options.notifyUploadComplete(a._currentFile,a._currentAttachmentId),c("#"+a._divIds.attachmentProgressBarId+a._uploadCounter).val(100));else if("VIRUS"===
b)a._postPollRequest(),c("#"+a._divIds.attachmentProgressBarsId).append(a._getErrorMessageHtml(a._attachmentStrings.malwareDetected)),a._log.error("Client tried to upload malware"),a._bindRemoveClickEvent();else if("ERROR"===b||"SCAN_ERROR"===b)a._postPollRequest(),c("#"+a._divIds.attachmentProgressBarsId).append(a._getErrorMessageHtml(a._attachmentStrings.failedToUpload)),a._log.error("Upload Status returned as "+b),a._bindRemoveClickEvent();a._pollingSemaphore=0},error:function(b){a._postPollRequest();
c("#"+a._divIds.attachmentProgressBarsId).append(a._getErrorMessageHtml(a._attachmentStrings.serviceFailureMessage));a._pollingSemaphore=0;a._bindRemoveClickEvent()}}))};amzn.c2c.AttachmentUploader.prototype.hideUploadDiv=function(){c("#"+this._divIds.attachmentLinkId).hide()};amzn.c2c.AttachmentUploader.prototype.showUploadDiv=function(){c("#"+this._divIds.attachmentLinkId).show()};amzn.c2c.AttachmentUploader.prototype._setupFileSelector=function(){var a=this;c("#"+a._divIds.attachmentFileSelectorId).addClass("attachment-file-selector");
c("#"+a._divIds.attachmentLinkId).click(function(b){b.preventDefault();a._divIds.attachmentFileSelectorId&&(c("#"+a._divIds.attachmentFileSelectorId).attr("value",""),c("#"+a._divIds.attachmentFileSelectorId).click())});c("#"+a._divIds.attachmentFileSelectorId).change(function(b){a.uploadUrl="";a.pollUrl="";a._pollingNeeded=!0;b=c("#"+a._divIds.attachmentFileSelectorId)[0];var d={name:"",size:""};"undefined"!==typeof b?(b.files?(b=b.files[0],d.name=b.name):d.name=b.value.match(/[^\/\\]+$/)[0],d.size=
b.size,a._uploadCounter++,a.hideUploadDiv(),a._processFile(d)):a._log.error("Unkown file")})};amzn.c2c.AttachmentUploader.prototype._processFile=function(a){if(this._currentFile=a)this._isValidUploadRequest(a)?(c("#"+this._divIds.attachmentProgressBarsId).append(this._getUploadInitiatorHtml(a)),this._bindRemoveClickEvent(),this._uploadFile(a,g[this.options.serviceEnv][this.options.serviceGeo])):this._log.warn("Invalid upload request")};amzn.c2c.AttachmentUploader.prototype._bindRemoveClickEvent=function(){var a=
this;c("#"+a._divIds.cancelButton+a._uploadCounter).addClass("attachment-cancel-button");c("#"+a._divIds.cancelButton+a._uploadCounter).bind("click",function(b){c("#"+a._divIds.attachmentUploadProgressId+a._uploadCounter).remove();a.showUploadDiv();a.stopPolling();a._pollingNeeded=!1})};amzn.c2c.AttachmentUploader.prototype._getProgressBarHtml=function(){return c.browser.msie?"<div id="+this._divIds.attachmentProgressBarId+this._uploadCounter+">NaN<input id="+this._divIds.cancelButton+this._uploadCounter+
' type="button" value=\''+this._attachmentStrings.cancelAttachment+"'></input> ":"<progress class='attachment-prog-bar' id="+this._divIds.attachmentProgressBarId+this._uploadCounter+' value="0" max="100.0"></progress><input id='+this._divIds.cancelButton+this._uploadCounter+' type="button" value=\''+this._attachmentStrings.cancelAttachment+"'></input> "};amzn.c2c.AttachmentUploader.prototype._getUploadInitiatorHtml=function(a){return"<div id="+this._divIds.attachmentUploadProgressId+this._uploadCounter+
"><span class='attachment-name'>"+a.name+" "+this._getProgressBarHtml()+"</div>"};amzn.c2c.AttachmentUploader.prototype._getErrorMessageHtml=function(a){return"<div id="+this._divIds.attachmentUploadProgressId+this._uploadCounter+"><span class='attachment-error-message'>"+a+"</span><input id="+this._divIds.cancelButton+this._uploadCounter+' type="button" value=\''+this._attachmentStrings.cancelAttachment+"'></input></div>"};amzn.c2c.AttachmentUploader.prototype._isValidUploadRequest=function(a){var b=
!0;this._checkFileSizeLimit(a)?this._isFileFormatValid(a.name)||(c("#"+this._divIds.attachmentProgressBarsId).append(this._getErrorMessageHtml(this._attachmentStrings.invalidFileFormat+" "+a.name)),this._log.warn("Invalid file format detected"),b=!1):(c("#"+this._divIds.attachmentProgressBarsId).append(this._getErrorMessageHtml(this._attachmentStrings.fleErrorMessage)),this._log.warn("file limit validation failed."),b=!1);!1===b&&this._bindRemoveClickEvent();return b};amzn.c2c.AttachmentUploader.prototype._isFileFormatValid=
function(a){if(!a||-1==a.lastIndexOf(".")||a.lastIndexOf(".")==a.length-1)return!1;a=a.substr(a.lastIndexOf(".")+1);for(var b=0;b<f.length;b++)if(f[b]==a.toLowerCase())return!0;return!1};amzn.c2c.AttachmentUploader.prototype._checkFileSizeLimit=function(a){return 10485760<a.size?!1:!0};amzn.c2c.AttachmentUploader.prototype._uploadFile=function(a,b){var d=this;"undefined"===typeof b?c("#"+d._divIds.attachmentProgressBarId+d._uploadCounter).replaceWith("<span class='attachment-error-message'>"+d._attachmentStrings.serviceFailureMessage+
"</span>"):(c("#"+d._divIds.attachmentProgressBarId+d._uploadCounter).val(10),e.ajax({url:b+"/GetUploadUrl",type:"GET",dataType:"xml",data:"chatId="+d.options.chatId,success:function(a){ajaxResult={uploadUrl:e(a).find("uploadUrl").text(),pollUrl:e(a).find("pollUrl").text(),aid:e(a).find("attachmentId").text()};d.getUploadUrlSuccess(ajaxResult)},error:function(){c("#"+d._divIds.attachmentProgressBarsId).append(d._getErrorMessageHtml(d._attachmentStrings.fleErrorMessage));d._bindRemoveClickEvent()}}))};
amzn.c2c.AttachmentUploader.prototype._getStandardizedFileSize=function(a){return"undefined"==typeof a||"undefined"==typeof a.size?null:1024<a.size?(Math.round(100*a.size/1048576)/100).toString()+"MB":(Math.round(100*a.size/1024)/100).toString()+"KB"};amzn.c2c.AttachmentUploader.prototype._getAttachmentIds=function(){var a=[],b;for(b in self._attachmentIds)self._attachmentIds.hasOwnProperty(b)&&a.push(self._attachmentIds[b]);return a};c.fn.amznAttachmentUploader=function(a){var b=null;this.each(function(){b=
new amzn.c2c.AttachmentUploader(a,this)});return b}})(e)};window.P&&window.P.AUI_BUILD_DATE?P.when("jQuery").execute(function(e){f(e);P.register("TelephonyUploadAttachment",function(){})}):f(window.jQuery)})();
/* ******** */
(function(){var v=function(n){var b=window.amzn=window.amzn||{};"undefined"===typeof b.cs&&(b.cs={});"undefined"===typeof b.cs.log&&(b.cs.log={});"undefined"===typeof b.chat&&(b.chat={});"undefined"===typeof b.cstel&&(b.cstel={});(function(h){function d(a){this._topic=a.topic;this._onMessageReady=a.onMessageReady;this._log=a.log;this._messageWaitTime=a.messageWaitTime;this._onConnectionDead=a.onConnectionDead;this._onConnectionMaybeDead=a.onConnectionMaybeDead;this._keepAliveInterval=a.keepAliveInterval;
this._messageBuffer=[];this._messageBufferFirstSequence=0;this._recentMessageSeqs=[];this._recentMessageSeqMax=5;this._lastMessageAddedTime=this._lastKeepAliveTime=null;this._log.debug("Topic buffer created")}"undefined"==typeof b&&(b={});"undefined"==typeof b.chat&&(b.chat={});var g={test:{na:"https://chat.integ.amazon.com",fe:"https://chat-fe.integ.amazon.com",eu:"https://chat-eu.integ.amazon.com",cn:"https://chat-cn.integ.amazon.com"},master:{na:"https://chat-preprod.amazon.com",fe:"https://chat-fe-preprod.amazon.com",
eu:"https://chat-eu-preprod.amazon.com",cn:"https://chat-cn-preprod.amazon.com"},prod:{na:"https://chat.amazon.com",fe:"https://chat.amazon.co.jp",eu:"https://chat.amazon.eu",cn:"https://chat.amazon.cn"}},f={CONNECTED:"CONNECTED",DISCONNECT:"DISCONNECT",KEEP_ALIVE:"KEEP_ALIVE",MESSAGE:"MESSAGE",PARTICIPANT_CHANGE:"PARTICIPANT_CHANGE",STATUS:"STATUS",TRANSCRIPT:"TRANSCRIPT",TRANSCRIPT_START:"TRANSCRIPT_START",TRANSFERRED:"TRANSFERRED",TRANSFER_FAILED:"TRANSFER_FAILED",ATTACHMENT:"ATTACHMENT",METADATA:"METADATA",
PARTIAL_MESSAGE:"PARTIAL_MESSAGE",BYPASS_BOT:"BYPASS_BOT",PARKED:"PARKED",TRANSLATION_FAILED:"TRANSLATION_FAILED"};b.chat.Action=f;b.chat.disconnectReasons={MESSAGE_TRANSPORT_ERROR:"MessageTransportError",UNKNOWN_ERROR:"UnknownError",USER_DISCONNECT:"UserHangup",AGENT_PARTICIPANT_CHANGE_TIMEOUT:"AgentParticipantChangeTimeout",GACD_HANGUP:"GacdHangup",DISCONNECT:"Disconnect",AGENT_PARKED:"AgentParked",BOT_GAVEUP:"BotGaveup",BOT_DISCONNECT:"BotDisconnect",BOT_PARKED:"BotParked",OVER_CAPACITY:"OverCapacity"};
b.chat.LocalParticipantId="self";b.chat.ChatServiceClient=function(a){this.constructor=b.chat.ChatServiceClient;a=h.extend({onDisconnected:function(a,k){},onConnectionDead:function(a){},onParticipantMessageReceived:function(a){},onPartialMessageReceived:function(a){},onParticipantChange:function(a){},onParticipantStatus:function(a){},onTranscriptReceived:function(a){},onTransferred:function(a){},onTransferFailed:function(){},onAttachmentReceived:function(){},onMetadataReceived:function(a){},onTranslationFailedMessageReceived:function(a){},
metricPublishCallBack:function(){},messageWaitTime:2E3},a);a.serviceHosts=g;b.cstel.BaseServiceClient.call(this,a);this._log=this.options.logger||b.cs.log.getLogger("chat");this._activeChatIds={};this._lastChatId=null;this._chatLegIdByChatId={};this._topicByChatId={};this._chatIdByTopic={};this._messageSequenceByChatId={};this._messagePollers={};this._topicBuffers={};this._log.info("chat client is initialized")};b.chat.ChatServiceClient.prototype=new b.cstel.BaseServiceClient;b.chat.ChatServiceClient.prototype._addTopicBuffer=
function(a,c){var k=this,e=new d({topic:a,keepAliveInterval:c,onMessageReady:function(a,c){k._processMessage(a,c)},onConnectionMaybeDead:function(){k._messagePollers[a].repoll(a)},onConnectionDead:function(){var c=k._chatIdByTopic[a];k._log.warn("Polling connection appears to be dead.",{topic:a,chatId:c});k.disconnect({chatId:c,reason:b.chat.disconnectReasons.MESSAGE_TRANSPORT_ERROR});k.options.onConnectionDead(c)},log:this._log,messageWaitTime:this.options.messageWaitTime});return this._topicBuffers[a]=
e};b.chat.ChatServiceClient.prototype._receiveMessages=function(a,c){this._lastMessageTime=(new Date).getTime();for(var k in a)if(a[k].body){var b=JSON.parse(a[k].body);if(b){var d=this._topicBuffers[c];d?d.add(b):this._log.warn("No buffer to receive message:",b.sequenceNumber,"on topic",c)}}};b.chat.ChatServiceClient.prototype._processMessage=function(a,c){this._log.debug("processing ",a.action," with Sequence Number : ",a.sequenceNumber);switch(a.type){case "NOTIFICATION":this._processNotification(a);
break;case "REQUEST":this._processRequest(a,c);break;case "RESPONSE":this._processResponse(a)}};b.chat.ChatServiceClient.prototype._processNotification=function(a){if(!a||!a.action||!a.data)throw this._log.debug("Malformed notification received from chat service",a),this.options.metricPublishCallBack("chat-client-malformed-msg","notification"),Error("Malformed notification received from chat service");switch(a.action){case f.MESSAGE:"TRANSLATION_FAILED"==a.processingStatus&&(a.data.translationFailed=
!0);this.options.onParticipantMessageReceived(a.data);break;case f.PARTIAL_MESSAGE:this.options.onPartialMessageReceived(a.data);break;case f.PARTICIPANT_CHANGE:this.options.onParticipantChange(a.data);break;case f.INVITE:this.options.onInvite(a.data);break;case f.STATUS:this.options.onParticipantStatus(a.data);break;case f.TRANSCRIPT:this.options.onTranscriptReceived(a.data);break;case f.TRANSFERRED:this.options.onTransferred(a.data);break;case f.TRANSFER_FAILED:this.options.onTransferFailed();break;
case f.ATTACHMENT:this.options.onAttachmentReceived(a.data);break;case f.METADATA:this.options.onMetadataReceived(a.data);break;case f.TRANSLATION_FAILED:this.options.onTranslationFailedMessageReceived(a.data)}};b.chat.ChatServiceClient.prototype._processRequest=function(a,c){if(!a||!a.action||void 0===a.sequenceNumber)throw this._log.debug("Malformed request received from chat service",a),this.options.metricPublishCallBack("chat-client-malformed-msg","request"),Error("Malformed request received from chat service");
var b=this._chatIdByTopic[c];switch(a.action){case f.KEEP_ALIVE:this._sendHeartbeat(a.sequenceNumber,b);break;case f.DISCONNECT:this._sendDisconnectAck(a.sequenceNumber,b)}};b.chat.ChatServiceClient.prototype._processResponse=function(a){if(!a)throw this._log.debug("Malformed response received from chat service.",a),this.options.metricPublishCallBack("chat-client-malformed-msg","response"),Error("Malformed response received from chat service.");};b.chat.ChatServiceClient.prototype._sendHeartbeat=
function(a,c){void 0!==a&&this._sendMessage({type:"RESPONSE",action:f.KEEP_ALIVE,sequence:a,chatId:c,body:{timestamp:(new Date).getTime()}})};b.chat.ChatServiceClient.prototype._sendDisconnectAck=function(a,c){if(void 0!==a&&this._activeChatIds[c]){var b=this;this._log.debug("Sending disconnect ack");var e=this._topicByChatId[c];this._messagePollers[e].endPolling();delete this._messagePollers[e];e=function(){b._tearDownChat(c)};delete this._activeChatIds[c];this._sendMessage({type:"RESPONSE",action:f.DISCONNECT,
chatId:c,sequence:a,onSuccess:e,onError:e})}};b.chat.ChatServiceClient.prototype._getNextSequence=function(a){"undefined"==typeof this._messageSequenceByChatId[a]&&(this._messageSequenceByChatId[a]=0);return this._messageSequenceByChatId[a]++};b.chat.ChatServiceClient.prototype.getDownloadUrl=function(a){var c=this,b={chatId:a.chatId,attachmentId:a.attachmentId};if(!a.chatId||!this._activeChatIds[a.chatId])throw a.onError(),this._log.debug("A valid, active chat ID is required",a.chatId),Error("A valid, active chat ID is required");
this._requestCoralJson({operation:"getDownloadAttachmentUrl",params:b,crossDomainXhrEnabled:!0,onSuccess:function(c){a.onSuccess(c.url)},onError:function(b){c._log.error("FAILED to get download url for chat ",a.chatId);a.onError()}})};b.chat.ChatServiceClient.prototype._sendMessage=function(a){var c={chatLegId:this._chatLegIdByChatId[a.chatId],"message.type":a.type,"message.action":a.action,"message.sequence":a.sequence,"message.conversationId":a.chatId||null};"undefined"==typeof c["message.sequence"]&&
(c["message.sequence"]=this._getNextSequence(a.chatId));a.chatId&&(c.chatId=a.chatId);if(a.body){var b=0,e;for(e in a.body)b++,c["message.body.entry."+b+".key"]=e,c["message.body.entry."+b+".value"]=a.body[e]}this._requestCoralJson(h.extend({operation:"sendMessage",params:c,hasResult:!1,crossDomainXhrEnabled:!0},a))};b.chat.ChatServiceClient.prototype._tearDownChat=function(a){if(!this._activeChatIds[a]){var c=this._chatLegIdByChatId[a],b=this._topicByChatId[a],e=this._topicBuffers[b];e&&(this._log.debug("clearing the timer for checking connection"),
e.stop());if(e=this._messagePollers[b])this._log.debug("ending the long polling"),e.endPolling();delete this._chatLegIdByChatId[a];delete this._topicByChatId[a];delete this._messageSequenceByChatId[a];delete this._topicBuffers[b];delete this._chatIdByTopic[b];delete this._messagePollers[b];this._log.debug("Tore down chatId:",a);this.options.onDisconnected(a,c)}};b.chat.ChatServiceClient.prototype._publishStatus=function(a){this._sendMessage(h.extend({chatId:a.chatId,type:"NOTIFICATION",action:f.STATUS,
maxRetries:1,body:{status:a.status},onSuccess:a.onSuccess||function(){},onError:a.onError||function(){}},a))};b.chat.ChatServiceClient.prototype._checkIsUserErrorCode=function(a,c,b){var e=!1;if(null==a&&0<=c.indexOf(b))return!0;try{var d=JSON.parse(a.response);0<=c.indexOf(d.Error.Code)&&(e=!0)}catch(f){this._log.error("JSON parsing error for response: "+a)}return e};d.prototype.stop=function(a){this._stopCheckingConnection()};d.prototype.add=function(a){var c=(new Date).getTime();this._isKeepAliveRequest(a)&&
(this._lastKeepAliveTime=c);this._lastMessageAddedTime=c;if(TelephonyUtil.Array.contains(this._recentMessageSeqs,a.sequenceNumber))this._log.warn("Duplicate message received with seq",a.sequenceNumber);else if(this._recentMessageSeqs.push(a.sequenceNumber),this._recentMessageSeqs.length>this._recentMessageSeqMax&&this._recentMessageSeqs.shift(),a.sequenceNumber<this._messageBufferFirstSequence)this._log.warn("Message received outside buffer, processing right away: ",a.sequenceNumber),this._onMessageReady(a,
this._topic);else if(this._isKeepAliveRequest(a))this._onMessageReady(a,this._topic),c=h.extend({},a,{type:"NOOP"}),this._placeMessageInBuffer(c);else{this._placeMessageInBuffer(a);var b=this;window.setTimeout(function(){for(;a.sequenceNumber>=b._messageBufferFirstSequence;){var c=b._dequeueFirstMessage();c&&(b._log.warn("Older message processing now: ",c.sequenceNumber),b._onMessageReady(c,b._topic))}},this._messageWaitTime);this._dequeueMessages()}};d.prototype.getLastMessageAddedTime=function(a){return this._lastMessageAddedTime};
d.prototype._isKeepAliveRequest=function(a){return"REQUEST"==a.type&&a.action==f.KEEP_ALIVE};d.prototype._placeMessageInBuffer=function(a){this._messageBuffer[a.sequenceNumber-this._messageBufferFirstSequence]=a};d.prototype._dequeueFirstMessage=function(){var a=this._messageBuffer.shift();this._messageBufferFirstSequence++;return a};d.prototype._dequeueMessages=function(){for(;this._messageBuffer[0];){var a=this._dequeueFirstMessage();this._onMessageReady(a,this._topic)}};d.prototype.beginCheckingConnection=
function(){this._lastKeepAliveTime=(new Date).getTime();if(!this._keepAliveInterval)throw Error("Keep alive interval not set!");var a=this,c=this._keepAliveInterval+4E3,b=this._keepAliveInterval+1E4,e=!1;window.clearInterval(this._connectionCheckInterval);this._connectionCheckInterval=window.setInterval(function(){if(a._lastKeepAliveTime){var d=(new Date).getTime()-a._lastKeepAliveTime;d>=b?(window.clearInterval(a._connectionCheckInterval),a._log.warn("Time since last keep alive request too long (failing)!",
d),a._onConnectionDead()):d>=c&&!e?(e=!0,a._log.warn("Time since last keep alive request too long (about to fail)!",d),a._onConnectionMaybeDead()):d<c&&(e=!1)}},500)};d.prototype._stopCheckingConnection=function(){window.clearInterval(this._connectionCheckInterval)};b.chat.ChatServiceClient.prototype.getTimeSinceLastMessage=function(a){a=this._topicByChatId[a];if(!a)return null;a=this._topicBuffers[a];return a?(a=a.getLastMessageAddedTime())?(new Date).getTime()-a:null:null};b.chat.ChatServiceClient.prototype.getLastChatId=
function(){return this._lastChatId};b.chat.ChatServiceClient.prototype.joinChat=function(a){var c=this;if(!a.topic)throw Error("topic required");if(!a.chatId)throw Error("chatId required");if(!a.chatLegId)throw Error("chatLegId required");if(!a.keepAliveInterval)throw Error("keepAliveInterval required");var d=a.topic,e=a.chatId,q=a.chatLegId,g=a.onError||function(){},h=a.onSuccess||function(){},m=this._addTopicBuffer(d,1E3*a.keepAliveInterval);c._chatLegIdByChatId[e]=q;c._topicByChatId[e]=d;c._chatIdByTopic[d]=
e;this._sendMessage({type:"NOTIFICATION",action:f.CONNECTED,chatId:e,onSuccess:function(a){c._log.debug("CONNECTED message sent successfully for chat ",e," and chat leg ",q);a=new b.chat.MessagePoller({chatLegId:q,serviceGeo:c.options.serviceGeo,serviceEnv:c.options.serviceEnv,serviceHosts:c.options.serviceHosts,logger:c._log});c._messagePollers[d]=a;m.beginCheckingConnection();a.startPolling({onMessages:function(a){c._receiveMessages(a,d)}});c._activeChatIds[e]=1;c._lastChatId=e;h()},onError:function(a,
b,d,k){c._log.error("CONNECTED message send failed for chat ",e," and chat leg ",q,b,d,k);g(a,b,d,k)||(c._log.error("Tearing down chat due to error sending CONNECTED message ",e,q),c._tearDownChat(e))}})};b.chat.ChatServiceClient.prototype.acceptAndJoinChat=function(a){if(!a.chatId)throw Error("chatId required");if(!a.chatLegId)throw Error("chatLegId required");var c=a.onJoinSuccess||function(){},b=a.onJoinError||function(){},d=a.onAcceptError||function(){},f=a.onAcceptSuccess||function(){},g=a.chatId,
l=a.chatLegId,m=a.preferences,t={chatLegId:l,chatId:g};if(m){var n=0,u;for(u in m)n++,t["preferences.entry."+n+".key"]=u,t["preferences.entry."+n+".value"]=m[u]}var r=this;this._requestCoralJson(h.extend({operation:"acceptChat",params:t,crossDomainXhrEnabled:!0,onSuccess:function(a){f(a);r.joinChat({keepAliveInterval:a.keepAliveInterval,topic:a.topicUrl,chatId:g,chatLegId:l,onSuccess:c,onError:b})},onError:d},a))};b.chat.ChatServiceClient.prototype.rejoinChat=function(a){var c=this;if(!a.chatId)throw Error("chatId required");
var b=a.onSuccess||function(){},d=a.onError||function(){};this._requestCoralJson(h.extend({operation:"rejoinChat",crossDomainXhrEnabled:!0,params:{chatId:a.chatId,participantId:a.participantId},isUserErrorCode:function(a,b,d,e){return c._checkIsUserErrorCode(a,["MediaLegNotFoundFault"],e)},onSuccess:function(a){b(a)},onError:function(a){d(a)}},a))};b.chat.ChatServiceClient.prototype.rejectChat=function(a){this._requestCoralJson(h.extend({operation:"rejectChat",hasResult:!1,crossDomainXhrEnabled:!0,
params:{chatLegId:a.chatLegId,chatId:a.chatId}},a))};b.chat.ChatServiceClient.prototype.pendingDisconnect=function(a){if(!a.chatId)throw Error("chatId required");var b=this._chatLegIdByChatId[a.chatId];b&&this._requestCoralJson(h.extend({operation:"pendingDisconnect",hasResult:!1,crossDomainXhrEnabled:!0,params:{chatLegId:b,chatId:a.chatId}},a))};b.chat.ChatServiceClient.prototype.resumeConversation=function(a){if(!a.chatId)throw Error("chatId required");var b=this._chatLegIdByChatId[a.chatId];b&&
this._requestCoralJson(h.extend({operation:"resumeConversation",hasResult:!1,crossDomainXhrEnabled:!0,params:{chatLegId:b,chatId:a.chatId}},a))};b.chat.ChatServiceClient.prototype.notifyTypingStarted=function(a){this._publishStatus(h.extend({chatId:a.chatId,status:"Composing"},a))};b.chat.ChatServiceClient.prototype.notifyTypingStopped=function(a){this._publishStatus(h.extend({chatId:a.chatId,status:"Paused"},a))};b.chat.ChatServiceClient.prototype.notifyUploadingStarted=function(a){this._publishStatus(h.extend({chatId:a.chatId,
status:"Uploading"},a))};b.chat.ChatServiceClient.prototype.notifyUploadingStopped=function(a){this._publishStatus(h.extend({chatId:a.chatId,status:"StoppedUploading"},a))};b.chat.ChatServiceClient.prototype.endConnectionForChat=function(a){var b=a.chatId,d=a.onSuccess||function(){},e=a.onError||function(){};this._activeChatIds[b]?(delete this._activeChatIds[b],this._publishStatus(h.extend({chatId:b,status:"Away",onSuccess:d,onError:e},a)),this._tearDownChat(b)):this._log.warn("Chat is not active for chatId - "+
b)};b.chat.ChatServiceClient.prototype.publishPartialMessage=function(a){var b=a.onError||function(){};this._sendMessage({chatId:a.chatId,type:"NOTIFICATION",action:f.PARTIAL_MESSAGE,body:{text:a.partialMessage},maxRetries:1,onSuccess:(a.onSuccess||function(){})(a.partialMessage),onError:b})};b.chat.ChatServiceClient.prototype.publishAttachment=function(a){var b=a.chatId,d=a.message,e=a.onError||function(){};a=a.onSuccess||function(){};if(!b||!this._activeChatIds[b])throw this._log.debug("A valid, active chat ID is required",
b),Error("A valid, active chat ID is required");this._sendMessage({chatId:b,type:"NOTIFICATION",action:f.ATTACHMENT,body:{name:d.name,size:d.size,id:d.id},timeout:2E4,onSuccess:a,onError:e})};b.chat.ChatServiceClient.prototype.publishMessage=function(a){var b=a.chatId,d=a.message,e=a.onError||function(){};a=a.onSuccess||function(){};if(!b||!this._activeChatIds[b])throw this._log.debug("A valid, active chat ID is required",b),Error("A valid, active chat ID is required");this._sendMessage({chatId:b,
type:"NOTIFICATION",action:f.MESSAGE,body:{text:d},timeout:2E4,onSuccess:a,onError:e})};b.chat.ChatServiceClient.prototype.publishMetadata=function(a){var b=a.onError||function(){},d=a.onSuccess||function(){},e=a.chatId;if(!e||!this._activeChatIds[e])throw this._log.debug("A valid, active chat ID is required",e),Error("A valid, active chat ID is required");this._sendMessage({chatId:e,type:"NOTIFICATION",action:f.METADATA,body:{text:a.text,transcriptText:a.transcriptText||"",relatedData:a.relatedData},
timeout:2E4,onSuccess:d,onError:b})};b.chat.ChatServiceClient.prototype.publishBypassBotMessage=function(a){var b=a.chatId,d=a.onError||function(){};a=a.onSuccess||function(){};if(!b||!this._activeChatIds[b])throw this._log.debug("A valid, active chat ID is required",b),Error("A valid, active chat ID is required");this._sendMessage({chatId:b,type:"NOTIFICATION",action:f.BYPASS_BOT,body:{chatId:b},timeout:2E4,onSuccess:a,onError:d})};b.chat.ChatServiceClient.prototype.repoll=function(a){(a=this._topicByChatId[a])&&
this._messagePollers[a].repoll(a)};b.chat.ChatServiceClient.prototype.parkChat=function(a){var b=this,d=a.chatId,e=a.chatLegId,f=a.parkNote;if(!d||!this._activeChatIds[d])throw Error("A valid, active chat ID is required");if(!e)throw Error("chatLegId required");var g=a.onParkSuccess||function(){},l=a.onParkError||function(){};this._requestCoralJson(h.extend({operation:"parkChat",hasResult:!1,crossDomainXhrEnabled:!0,params:{chatId:d,chatLegId:e,parkNote:f},isUserErrorCode:function(a,d,e,f){return b._checkIsUserErrorCode(a,
["UnsupportedOperationFault","MediaLegNotFoundFault"])},onSuccess:function(a){delete b._activeChatIds[d];b._tearDownChat(d);g(a)},onError:function(a){l(a)}},a))};b.chat.ChatServiceClient.prototype.disconnect=function(a){var d=this,f=a.chatId,e=a.onSuccess||function(){},g=a.onError||function(){};if(this._activeChatIds[f])if(f){var p=this._chatLegIdByChatId[f];if(p){var l=this._topicByChatId[f],m;this._messagePollers[l]&&(m=this._messagePollers[l].getTopicHistoryString(l),this._messagePollers[l].endPolling());
a.onError=function(a){d._tearDownChat(f);g(a)};a.onSuccess=function(a){d._tearDownChat(f);e(a)};delete this._activeChatIds[f];this._requestCoralJson(h.extend({operation:"disconnect",hasResult:!1,timeout:4E4,crossDomainXhrEnabled:!0,params:{chatLegId:p,chatId:f,reason:a.reason||b.chat.disconnectReasons.USER_DISCONNECT,pollHistory:m}},a))}else e()}else e();else d._log.warn("disconnect ignored, chat not active",a),e()};b.chat.ChatServiceClient.prototype.disconnectWithBeacon=function(a){var d=this,f=
a.chatId,e=a.onSuccess||function(){};if(this._activeChatIds[f])if(f){var g=this._chatLegIdByChatId[f];if(g){var p=this._topicByChatId[f],l;this._messagePollers[p]&&(l=this._messagePollers[p].getTopicHistoryString(p),this._messagePollers[p].endPolling());var m=function(){d._tearDownChat(f)};a.onSuccess=function(a){m();e(a)};delete this._activeChatIds[f];this._requestCoralJson(h.extend({operation:"disconnect",hasResult:!0,timeout:4E4,crossDomainXhrEnabled:!1,beacon:!0,params:{chatLegId:g,chatId:f,reason:a.reason||
b.chat.disconnectReasons.USER_DISCONNECT,pollHistory:l},onError:m},a))}else e()}else e();else d._log.warn("disconnect ignored, chat not active",a),e()}})(n);(function(h){"undefined"==typeof b&&(b={});"undefined"==typeof b.chat&&(b.chat={});b.chat.MessagePoller=function(d){this.constructor=b.chat.MessagePoller;d=h.extend({subscribeTimeout:6E3,logger:null},d);b.cstel.BaseServiceClient.call(this,d);this._chatLegId=d.chatLegId;if(!this._chatLegId)throw Error("chatLegId is a required option.");this._owningChain=
0;this._log=d.logger||b.cs.log.getLogger("message-poller-"+this._chatLegId);this._pollHistory=[]};b.chat.MessagePoller.prototype=new b.cstel.BaseServiceClient;b.chat.MessagePoller.prototype._getNextPollChainId=function(){return++this._owningChain};b.chat.MessagePoller.prototype._getJsonpPollingChannelName=function(b){return"pollChainId:"+b+"-chatLegId:"+this._chatLegId};b.chat.MessagePoller.prototype._cleanupJsonpChannels=function(d){for(var g=0;g<=d;g++){var f=this._getJsonpPollingChannelName(g);
b.coraljsonp.cleanupChannel(f)}};b.chat.MessagePoller.prototype._addToHistory=function(b,g){var f=0,a=this._pollHistory[this._pollHistory.length-1];a&&(f=b-a.time);this._pollHistory.push({text:g,time:b,timeSinceLast:f});3<this._pollHistory.length&&(this._pollHistory=this._pollHistory.slice(1))};b.chat.MessagePoller.prototype._longPoll=function(b){var g=b.chain;if("undefined"==typeof g)throw Error("chain must be set");this._owningChain=g;var f=(new Date).getTime(),a={chatLegId:this._chatLegId,chain:this._owningChain,
time:f};if(b.messagesToAck)for(var c=0,h=b.messagesToAck.length;c<h;++c)a["acknowledgedMessageIds.member."+(c+1)]=b.messagesToAck[c].id;this._addToHistory(f,"new");var e=this;this._requestCoralJson({operation:"longPoll",params:a,timeout:null,hasResult:!0,maxRetries:0,crossDomainXhrEnabled:!0,jsonpChannel:this._getJsonpPollingChannelName(this._owningChain),onSuccess:function(a){e._handleLongPollSuccess(a,g,e._handleLongPollError)},onError:function(a,b,d,c){return e._handleLongPollError(a,b,d,c)}})};
b.chat.MessagePoller.prototype._handleLongPollSuccess=function(b,g,f){b.messages&&this._messagesCallback&&this._messagesCallback(b.messages);b.ERROR&&("TIMEOUT"==b.ERROR?this._log.info("Received TIMEOUT response from chat service longPoll"):f(null,"transportError",b.ERROR,b.ERROR));g===this._owningChain?this._longPoll({chain:g,messagesToAck:b.messages}):this._log.info("Chain ("+g+") no longer the most current ("+this._owningChain+"). This polling chain ended.")};b.chat.MessagePoller.prototype._handleLongPollError=
function(b,g,f,a){var c=this;if("timeout"==g)return this._log.warn(f),!0;if(b){this._log.error(b,g,f,a);if(b.response&&(b=JSON.parse(b.response),b.Error&&"MediaLegNotFoundFault"===b.Error.Code))return this._log.info("Server has already detroyed the media leg. Discontinue polling"),c.endPolling(),!0;window.setTimeout(function(){c.repoll()},2E3);return!0}};b.chat.MessagePoller.prototype.startPolling=function(b){this._log.debug("Polling started for chatLegId ",this._chatLegId);this._messagesCallback=
b.onMessages||function(b){};this._longPoll({chain:0})};b.chat.MessagePoller.prototype.endPolling=function(){var b=this._owningChain;-1===b?this._log.warn("Polling already ended for ",this._chatLegId):(this._owningChain=-1,this._cleanupJsonpChannels(b),this._log.debug("Polling stopped for chatLegId ",this._chatLegId))};b.chat.MessagePoller.prototype.repoll=function(){-1===this._owningChain?this._log.warn("repoll called, but polling ended (owning chain \x3d\x3d -1)"):this._longPoll({chain:this._getNextPollChainId()})};
b.chat.MessagePoller.prototype.getTopicHistoryString=function(b){return h.map(this._pollHistory,function(b){return b.time+"-"+b.timeSinceLast+"-"+b.text}).join("__")}})(n)},r=window.AmazonUIPageJS||window.P;r?r.when("jQuery","TelephonyC2CCommon").execute(function(n){v(n);r.register("RavenChatClient",function(){})}):v(window.jQuery)})();
/* ******** */
(function(){var n=function(h){var b=window.amzn=window.amzn||{};"undefined"===typeof b.cs&&(b.cs={});"undefined"===typeof b.cs.log&&(b.cs.log={});"undefined"===typeof b.chat&&(b.chat={});"undefined"===typeof b.cstel&&(b.cstel={});(function(k){"undefined"==typeof b&&(b={});"undefined"==typeof b.chat&&(b.chat={});var e=b.chat.LocalParticipantId;b.chat.storageKey={chatId:"chatId",participantId:"participantId"};b.chat.ChatCustomerController=function(a){var c=this;this.options=k.extend({serviceEnv:"test",
serviceGeo:"na",onConnectionDead:function(a,c){},onExperiencingConnectionDrop:function(a){},onAttemptingToReconnect:function(){},onAttemptingToRejoin:function(){},onConnectionRecovered:function(a){},rejoinArgsForConnectionDrop:{},isAsynchronousChat:!1,getValueFromStorage:function(a){},putValueInStorage:function(a,c){},removeAsyncDataFromStorage:function(a){},onOtherParticipantChangeReceived:function(a,c){},onMetadataMessageReceived:function(a,c){},onMessageReceived:function(a,c){},onAttachmentReceived:function(a,
c){},onBypassBotMessageReceived:function(a,c){},onTranscriptStart:function(a){},onTranscriptEmpty:function(){},onTranscriptEnd:function(){},renderInitialQuestion:!0,onAgentStartedTyping:function(a){},onAgentStoppedTyping:function(a){},onStaleConnection:function(){},onTransferring:function(){},onChatEnded:function(a){},logger:null,c2cServiceHostOverride:null,chatServiceHostOverride:null},a);this._log=this.options.logger||b.cs.log.getLogger("chat");a={serviceEnv:this.options.serviceEnv,serviceGeo:this.options.serviceGeo,
logger:this._log};this._chatClient=new b.chat.ChatServiceClient(k.extend(a,{serviceHost:this.options.chatServiceHostOverride,onParticipantMessageReceived:function(a){c._handleMessageReceived(a)},onDisconnected:function(a,b){c._handleDisconnected(a,b)},onConnectionDead:function(a){c._handleConnectionDead(a,"push connection dead")},onParticipantChange:function(a){c._handleParticipantChange(a)},onParticipantStatus:function(a){c._handleParticipantStatusUpdate(a)},onTransferred:function(a){c._handleTransferred(a)},
onAttachmentReceived:function(a){c._handleAttachmentReceived(a)},onMetadataReceived:function(a){c._handleMetadataReceived(a)},onTranscriptReceived:function(a){c._handleTranscript(a)}}));this._c2cClient=new b.c2c.C2CServiceClient(k.extend(a,{serviceHost:this.options.c2cServiceHostOverride}));this._initTranscriptParser();this._c2cStatusChecker=null;this._rejoinArgs=this.options.rejoinArgsForConnectionDrop||{};this._lastUsedInitiateChatArgs=null;this._chatIdsHistory=[];this._reconnectToken=this._connectionId=
this._chatId=null;this._reconnectAttemptsLeft=0;this._originalChatId=this._transcriptToken=null;this._chatsExpectedToDisconnect={};this._connectionsExpectedToDisconnect={};this.expectingTranscript=!1;this._agentCount=0;this._useTrustedChat=this._isChatPendingDisconnect=this._isChatPaused=!1;this._ongoingConnection="Initial";this.isWindowActive=!0};b.chat.ChatCustomerController.prototype._initTranscriptParser=function(){var a=this;a._transcriptParser=new b.chat.TranscriptParsingUtility({onParticipantChangeMessageReceived:function(c){a._handleParticipantChange(c,
!0)},onParticipantMessageReceived:function(c){a.options.onMessageReceived(c,!0)},onParticipantMetadataMessageReceived:function(c){a.options.onMetadataMessageReceived(c,!0)},onParticipantAttachmentMessageReceived:function(c){a.options.onAttachmentReceived(c,!0)},onBypassBotMessageReceived:function(c){a.options.onBypassBotMessageReceived(c,!0)},onTranscriptStart:function(c){a.options.onTranscriptStart(c)},onTranscriptEmpty:function(){a.options.onTranscriptEmpty()},onTranscriptEnd:function(){a.options.onTranscriptEnd()},
renderInitialQuestion:a.options.renderInitialQuestion})};b.chat.ChatCustomerController.prototype._handleMessageReceived=function(a){TelephonyUtil.isParamMissing(this._chatId)||(TelephonyUtil.isParamMissing(a.from)||TelephonyUtil.isParamMissing(a.text)?this._log.warn("Participant message doesn't have appropriate info"):(this._log.info("message received from "+a.from),this.options.onMessageReceived({participantId:a.from,text:a.text},!1)))};b.chat.ChatCustomerController.prototype._handleAttachmentReceived=
function(a){TelephonyUtil.isParamMissing(this._chatId)||(TelephonyUtil.isParamMissing(a.from)||TelephonyUtil.isParamMissing(a.id)?this._log.warn("Attachment message doesn't have appropriate info"):(this._log.info("attachment received from "+a.from),this.options.onAttachmentReceived({participantId:a.from,id:a.id,name:a.name,size:a.size},!1)))};b.chat.ChatCustomerController.prototype._handleMetadataReceived=function(a){TelephonyUtil.isParamMissing(this._chatId)||(TelephonyUtil.isParamMissing(a.from)||
TelephonyUtil.isParamMissing(a.text)?this._log.warn("Metadata message doesn't have appropriate info"):(this._log.info("metadata message received from "+a.from),this.options.onMetadataMessageReceived({participantId:a.from,text:a.text,transcriptText:a.transcriptText,relatedData:a.relatedData},!1)))};b.chat.ChatCustomerController.prototype._handleDisconnected=function(a,c){if(this._chatsExpectedToDisconnect[a]||this._connectionsExpectedToDisconnect[c]){if(this._chatsExpectedToDisconnect[a])this.options.onChatEnded(a);
delete this._chatsExpectedToDisconnect[a];delete this._connectionsExpectedToDisconnect[c]}else this._handleConnectionDead(a,"unexpected disconnect")};b.chat.ChatCustomerController.prototype._handleConnectionDead=function(a,c){if(this._chatId===a){this.options.onExperiencingConnectionDrop(a);var b=!1,d=this._chatClient.getTimeSinceLastMessage(a);if(null===d||12E4<d)b=!0,this._log.info("The customer's chat client has not Received a message for ",d,"ms, not going to attempt to reconnect.");this._log.error("the connection is dead, client has not receieved a message for ",
d," ms");if(this.options.isAsynchronousChat)this._attemptRejoin();else if(this._reconnectAttemptsLeft&&!b)this._reconnectAttemptsLeft--,this._attemptReconnect(a,c+" timeSinceLastMessage("+d+")");else this.options.onConnectionDead(a,c)}};b.chat.ChatCustomerController.prototype._attemptRejoin=function(){var a=this;this._connectionId&&(this._connectionsExpectedToDisconnect[this._connectionId]=!0);this.options.onAttemptingToRejoin();var c=this._rejoinArgs;c.onSuccess=function(c){a.options.onConnectionRecovered(c)};
this.rejoinChat(c)};b.chat.ChatCustomerController.prototype._attemptReconnect=function(a,c){var b=this;this._connectionId&&(this._connectionsExpectedToDisconnect[this._connectionId]=!0);this.options.onAttemptingToReconnect();var d=this._lastUsedInitiateChatArgs;d.onSuccess=function(a){b.options.onConnectionRecovered(a)};d.retryTimeLimit=12E4;d.maxRetries=null;d.reconnectReasonDebugMessage=c;this._initiateCustomerChat(d)};b.chat.ChatCustomerController.prototype._handleParticipantChange=function(a,
c){TelephonyUtil.isParamMissing(this._chatId)||(TelephonyUtil.isParamMissing(a.participant)?this._log.warn("Participant change message doesn't have participant info"):a.participant.participantId!==e&&this._handleAgentChange(a,c))};b.chat.ChatCustomerController.prototype._handleAgentChange=function(a,c){var f=a.participant;c||(f.reconnected=a.reconnected);if("CONNECTED"==f.state){if(this._agentCount++,this._log.info("Participant joined:",f.participantId),this._reconnectToken=a.reconnectToken)this._reconnectAttemptsLeft=
2}else{0<this._agentCount&&(this._agentCount--,this._log.info("Agent count:",this._agentCount));if(c)return this.options.onOtherParticipantChangeReceived(a,c);switch(f.disconnectReason){case b.chat.disconnectReasons.OVER_CAPACITY:case b.chat.disconnectReasons.USER_DISCONNECT:case b.chat.disconnectReasons.GACD_HANGUP:case b.chat.disconnectReasons.BOT_DISCONNECT:this._chatsExpectedToDisconnect[a.chatId]=!0;this.options.getValueFromStorage(b.chat.storageKey.chatId)&&this.options.removeAsyncDataFromStorage(a.chatId);
break;case b.chat.disconnectReasons.DISCONNECT:this.options.onTransferring();break;case b.chat.disconnectReasons.AGENT_PARKED:case b.chat.disconnectReasons.BOT_GAVEUP:case b.chat.disconnectReasons.BOT_PARKED:break;default:0===this._agentCount&&this._handleConnectionDead(a.chatId,f.userName+" left, reason: "+f.disconnectReason)}}this.options.onOtherParticipantChangeReceived({participant:f},c)};b.chat.ChatCustomerController.prototype._handleParticipantStatusUpdate=function(a){TelephonyUtil.isParamMissing(this._chatId)||
(TelephonyUtil.isParamMissing(a.from)||TelephonyUtil.isParamMissing(a.status)?this._log.warn("Participant status message doesn't have appropriate info"):a.from===e?this._handleCustomerStatusUpdate(a):this._handleAgentStatusUpdate(a))};b.chat.ChatCustomerController.prototype._handleCustomerStatusUpdate=function(a){"StaleConnection"===a.status&&(this._log.info("Customer is having an old connection."),this._connectionId&&(this._connectionsExpectedToDisconnect[this._connectionId]=!0),this.options.onStaleConnection())};
b.chat.ChatCustomerController.prototype._handleAgentStatusUpdate=function(a){switch(a.status){case "Composing":this.options.onAgentStartedTyping(a.from);break;case "Paused":this.options.onAgentStoppedTyping(a.from)}};b.chat.ChatCustomerController.prototype._handleTransferred=function(a){this._log.info("Transferred: ",a);a.reconnectToken&&(this._reconnectToken=a.reconnectToken,this._reconnectAttemptsLeft=2)};b.chat.ChatCustomerController.prototype._handleTranscript=function(a){a=a.messages;this.expectingTranscript&&
(this.expectingTranscript=!1,b.chat.TranscriptParsingUtility.parseTranscript(this._transcriptParser,a))};b.chat.ChatCustomerController.prototype.setupC2CStatusChecker=function(a){TelephonyUtil.isParamMissing(this._c2cStatusChecker)?(TelephonyUtil.validateParamIsNotMissing("args",a),TelephonyUtil.validateParamIsNotMissing("c2cId",a.c2cId),this._c2cStatusChecker=new b.c2c.C2CStatusChecker({c2cId:a.c2cId,serviceEnv:this.options.serviceEnv,serviceGeo:this.options.serviceGeo,serviceHost:this.options.c2cServiceHostOverride,
timezone:a.timezone,locale:a.locale,alwaysLookupHours:a.alwaysLookupHours,cache:!1,onOutOfHours:a.onOutOfHours||function(){},onNoAgents:a.onNoAgents||function(){},onDisabled:a.onDisabled||function(){},onError:a.onError||function(){},onAvailable:a.onAvailable||function(){},fakeInHours:a.alwaysShowInHours,fakeOutOfHours:a.alwaysShowOutOfHours,fakeAgentsAvail:a.alwaysShowAgentsAvail,fakeAgentsUnavail:a.alwaysShowAgentsUnavail}),this._log.info("C2C status checker setup for c2cId - "+a.c2cId)):this._log.warn("C2C status checker already setup")};
b.chat.ChatCustomerController.prototype.checkC2CStatus=function(){if(TelephonyUtil.isParamMissing(this._c2cStatusChecker))throw Error("C2C status checker not set up, aborting");this._c2cStatusChecker.checkNow()};b.chat.ChatCustomerController.prototype.startPeriodicC2CStatusChecker=function(a){if(TelephonyUtil.isParamMissing(this._c2cStatusChecker))throw Error("C2C status checker not set up, aborting");this._c2cStatusChecker.startPeriodicCheck(a)};b.chat.ChatCustomerController.prototype.stopPeriodicC2CStatusChecker=
function(){if(TelephonyUtil.isParamMissing(this._c2cStatusChecker))throw Error("C2C status checker not set up, aborting");this._c2cStatusChecker.stopPeriodicCheck()};b.chat.ChatCustomerController.prototype.getC2CStatusChecker=function(){return this._c2cStatusChecker};b.chat.ChatCustomerController.prototype.startTrustedChat=function(a){TelephonyUtil.validateParamIsNotMissing("args",a);a.mock?this._initiateFakeChat(a):(TelephonyUtil.validateParamIsNotMissing("c2cId",a.c2cId),TelephonyUtil.validateParamIsFunction("initiateTrustedChatCallback",
a.initiateTrustedChatCallback),this._useTrustedChat=!0,this._initiateCustomerChat(a))};b.chat.ChatCustomerController.prototype.startChat=function(a){TelephonyUtil.validateParamIsNotMissing("args",a);a.mock?this._initiateFakeChat(a):(TelephonyUtil.validateParamIsNotMissing("c2cId",a.c2cId),TelephonyUtil.validateParamIsFunction("getNewContextId",a.getNewContextId),this._useTrustedChat=!1,this._initiateCustomerChat(a))};b.chat.ChatCustomerController.prototype._initiateCustomerChat=function(a){var c=
this,f=a.onSuccess||function(){},d=a.onSubscribing||function(){},g=a.onError||function(){},e=a.onBlocked||function(){},k=a.onConcurrentBlocked||function(){};this._lastUsedInitiateChatArgs=a;this._agentCount=0;var h=this._reconnectToken||a.reconnectToken,p=function(a,f){var d={initFailReason:a,status:f[1],message:f[2],code:f[3]};c._log.error("start customer chat failure",d);switch(d.code){case "UserBlockedFault":e();break;case "ConcurrentChatBlockedFault":k();break;default:c.endChat({reason:b.chat.disconnectReasons.UNKNOWN_ERROR}),
g("start customer chat failure",d)}},l=function(a){d();c.options.isAsynchronousChat&&c.options.putValueInStorage(a.chatId,a.participantId);c._chatId=a.chatId;c._connectionId=a.chatLegId;c._transcriptToken=a.transcriptToken;c._updateRejoinArgs(a.chatId,a.participantId);c._chatIdsHistory.push(a.chatId);c._originalChatId||(c._originalChatId=a.chatId);c._chatClient.joinChat({topic:a.topicUrl,chatId:a.chatId,chatLegId:a.chatLegId,keepAliveInterval:a.keepAliveInterval,onError:function(){p("joinChat failed",
arguments)},onSuccess:function(){f(a.chatId)}})};if(this._useTrustedChat&&!h){var m=a.initiateTrustedChatCallback(a.customerName,a.customerInitialQuestion,a.customerIdentifier,a.customerIdentifierType,a.allowPhoneNumberIdentifier,a.screenShareRequested,a.pushMessageMethod,a.pushMessageParam),q=function(a){!a||"string"==typeof a.error&&0<a.error.length?p(a,[null,"error","startTrustedChatFailure",a?a.error:null]):l(a)};if(m instanceof XMLHttpRequest){var r=m.onloadend;m.onloadend=function(){var a=JSON.parse(m.response);
q(a);"function"==typeof r&&r()}}else q(m)}else{var n=a.getNewContextId();this._c2cClient.initiateChat({contextId:n,c2cId:a.c2cId,userName:a.customerName,customerIdentifier:a.customerIdentifier,customerIdentifierType:a.customerIdentifierType,allowPhoneNumberIdentifier:a.allowPhoneNumberIdentifier,userInitialQuestion:a.customerInitialQuestion,reconnectToken:h,reconnectReasonDebugMessage:a.reconnectReasonDebugMessage,retryTimeLimit:a.retryTimeLimit,maxRetries:a.maxRetries,pushMessageParam:a.pushMessageParam,
pushMessageMethod:a.pushMessageMethod,preferences:a.preferences,onError:function(){p("c2c initiateChat failed",arguments)},onSuccess:function(a){l(a)}})}};b.chat.ChatCustomerController.prototype._initiateFakeChat=function(a){(a.onSuccess||function(){})("FAKECHATID",{mock:!0});this._handleAgentChange({chatId:"FAKECHATID",participant:{state:"CONNECTED",participantId:"FakeAgent",displayName:"FakeAgent"},mock:!0})};b.chat.ChatCustomerController.prototype._exitFakeAgent=function(){this._handleAgentChange({chatId:"FAKECHATID",
participant:{state:"DISCONNECTED",participantId:"FakeAgent",displayName:"FakeAgent"},mock:!0})};b.chat.ChatCustomerController.prototype.rejoinChat=function(a){var c=this;TelephonyUtil.validateParamIsNotMissing("args",a);TelephonyUtil.validateParamIsNotMissing("chatId",a.chatId);this._agentCount=0;var f=a.onSuccess||function(){},d=a.onSubscribing||function(){},g=a.onError||function(){},e=a.onChatNotFound||function(){},k=function(){c._log.warn("MediaLegNotFoundFault when trying to rejoin.");c._chatsExpectedToDisconnect[a.chatId]=
!0;c.options.getValueFromStorage(b.chat.storageKey.chatId)&&c.options.removeAsyncDataFromStorage(a.chatId);e(a.chatId);c._rejoinArgs.chatId=c._chatId=null},h=function(a){c.expectingTranscript=!0;d();c._chatId=a.chatId;c._connectionId=a.chatLegId;c._originalChatId||(c._originalChatId=a.chatId);c._updateRejoinArgs(a.chatId,a.participantId);c._chatClient.joinChat({topic:a.topicUrl,chatId:a.chatId,chatLegId:a.chatLegId,keepAliveInterval:a.keepAliveInterval,onError:function(){c._ongoingConnection="None";
g("joinChat failed while rejoining")},onSuccess:function(){c._ongoingConnection="None";c.options.putValueInStorage(a.chatId,a.participantId);f(a.chatId);c.isWindowActive||(c._log.error("PauseChat was called after a successful rejoin, because the window became inactive."),c.pauseChat())}})};this._chatClient.rejoinChat({chatId:a.chatId,participantId:a.participantId,onError:function(b,f,d,e){a:if(c._log.error("rejoinChat failure for chatId: ",a.chatId,b),null==b&&"MediaLegNotFoundFault"===e)k();else{if(b instanceof
XMLHttpRequest)try{if(b=JSON.parse(b.response),"MediaLegNotFoundFault"===b.Error.Code){k();break a}}catch(h){c._log.error("Error while parsing rejoinchat response")}g(b)}},onSuccess:function(a){h(a)}});this._ongoingConnection="Resume"};b.chat.ChatCustomerController.prototype._updateRejoinArgs=function(a,c){this._rejoinArgs.chatId=a;this._rejoinArgs.participantId=c};b.chat.ChatCustomerController.prototype.createUploadAttachment=function(a){TelephonyUtil.validateParamIsNotMissing("args",a);TelephonyUtil.validateParamIsNotMissing("attachmentContainer",
a.attachmentContainer);a.showAttachmentButton&&TelephonyUtil.validateParamIsNotMissing("attachmentCellSelector",a.attachmentCellSelector);var c=a.preUploadCallback||function(){},b=a.notifyUploadComplete||function(){},d=a.notifyUploadingStarted||function(){},g=a.notifyUploadingStopped||function(){};return k(a.attachmentContainer).amznAttachmentUploader({showAttachmentButton:a.showAttachmentButton,attachmentCellSelector:a.attachmentCellSelector,serviceEnv:a.serviceEnv,serviceGeo:a.serviceGeo,isDisplayUploadedFile:a.isDisplayUploadedFile,
chatId:this._chatId,strings:a.attachmentStrings,enableProgressBar:a.enableProgressBar,preUploadCallback:c,notifyUploadComplete:b,notifyUploadingStarted:d,notifyUploadingStopped:g})};b.chat.ChatCustomerController.prototype.isValidImageFileExt=function(a){return b.cs.attachment.isValidImageFileExt(a)};b.chat.ChatCustomerController.prototype.sendMessage=function(a){var c=this,b=this._chatId;TelephonyUtil.validateParamIsNotMissing("args",a);TelephonyUtil.validateParamIsNotMissing("text",a.text);var d=
a.onSuccess||function(){},g=a.onError||function(){};this._chatClient.publishMessage({chatId:b,message:a.text,onError:function(){c._log.error("Sending message failed for chatId - "+b);g()},onSuccess:function(){c._log.info("Sending message for chatId - "+b);d()}})};b.chat.ChatCustomerController.prototype.sendMetadataMessage=function(a){var c=this,b=this._chatId;TelephonyUtil.validateParamIsNotMissing("args",a);TelephonyUtil.validateParamIsNotMissing("metadataType",a.metadataType);var d=a.onSuccess||
function(){},g=a.onError||function(){};this._chatClient.publishMetadata({chatId:b,text:a.metadataType,relatedData:a.relatedData,transcriptText:a.transcriptText||"",onError:function(){c._log.error("Sending metadata message failed for chatId - "+b);g()},onSuccess:function(){c._log.info("Sending metadata message for chatId - "+b);d()}})};b.chat.ChatCustomerController.prototype.sendBypassBotMessage=function(a){var c=this,b=this._chatId;TelephonyUtil.validateParamIsNotMissing("args",a);var d=a.onSuccess||
function(){},g=a.onError||function(){};this._chatClient.publishBypassBotMessage({chatId:b,onError:function(a){c._log.error("Sending bypass bot failed for chatId - "+b);g(a)},onSuccess:function(){c._log.info("Sending bypass bot for chatId - "+b);d()}})};b.chat.ChatCustomerController.prototype.sendAttachment=function(a){var c=this,b=this._chatId;TelephonyUtil.validateParamIsNotMissing("args",a);TelephonyUtil.validateParamIsNotMissing("fileName",a.fileName);TelephonyUtil.validateParamIsNotMissing("fileSize",
a.fileSize);TelephonyUtil.validateParamIsNotMissing("attachmentId",a.attachmentId);var d=a.onSuccess||function(){},g=a.onError||function(){};this._chatClient.publishAttachment({chatId:b,message:{name:a.fileName,size:a.fileSize,id:a.attachmentId},onError:function(){c._log.error("Sending attachment failed for chatId - "+b);g()},onSuccess:function(){c._log.info("Sending attachment for chatId - "+b);d()}})};b.chat.ChatCustomerController.prototype.sendPartialMessage=function(a){var c=this,b=c._chatId;
TelephonyUtil.validateParamIsNotMissing("args",a);TelephonyUtil.validateParamIsNotMissing("partialMessage",partialMessage);var d=a.onSuccess||function(){},g=a.onError||function(){};c._chatClient.publishPartialMessage({chatId:b,partialMessage:partialMessage,onSuccess:function(a){c._log.info("Sending partial message for chatId - "+b);c._previousPartialMessage=a;d()},onError:function(){c._log.error("Sending partial message failed for chatId - "+b);g()}})};b.chat.ChatCustomerController.prototype.sendTypingStartedNotification=
function(){this._chatClient.notifyTypingStarted({chatId:this._chatId})};b.chat.ChatCustomerController.prototype.sendTypingStoppedNotification=function(){this._chatClient.notifyTypingStopped({chatId:this._chatId})};b.chat.ChatCustomerController.prototype.sendUploadingStartedNotification=function(){this._chatClient.notifyUploadingStarted({chatId:this._chatId})};b.chat.ChatCustomerController.prototype.sendUploadingStoppedNotification=function(){this._chatClient.notifyUploadingStopped({chatId:this._chatId})};
b.chat.ChatCustomerController.prototype.uploadFile=function(a){};b.chat.ChatCustomerController.prototype.getAttachmentDownloadUrl=function(a){var c=this._chatId;TelephonyUtil.validateParamIsNotMissing("args",a);TelephonyUtil.validateParamIsNotMissing("attachmentId",a.attachmentId);var b=a.onSuccess||function(){},d=a.onError||function(){};this._chatClient.getDownloadUrl({chatId:c,attachmentId:a.attachmentId,onError:function(){d()},onSuccess:function(a){b(a)}})};b.chat.ChatCustomerController.prototype.getChatId=
function(){return this._chatId};b.chat.ChatCustomerController.prototype.getOtherParticipantCount=function(){return this._agentCount};b.chat.ChatCustomerController.prototype.pauseChat=function(a){var b=this;this.isWindowActive=!1;a=a||{};var e=a.onSuccess||function(){},d=a.onError||function(){};if("Resume"==this._ongoingConnection||"Pause"==this._ongoingConnection)this._log.error("pauseChat is called while ongoing connection is "+this._ongoingConnection+", hence ignoring.");else{a=this._chatId;this._connectionId&&
(this._connectionsExpectedToDisconnect[this._connectionId]=!0);var g=function(){b.isWindowActive&&"Resume"!=b._ongoingConnection?(b._log.error("RejoinChat was called after a pause, because the window became active."),b._ongoingConnection="None",b.resumeChat()):b._ongoingConnection="None"};this._chatClient.endConnectionForChat({chatId:a,onSuccess:function(){b._log.debug("Successfully published the away message from app pause/page not visible");g();e()},onError:function(){b._log.error("Failed to send the away message from app pause/page not visible");
g();d()}});this._ongoingConnection="Pause"}};b.chat.ChatCustomerController.prototype.resumeChat=function(){this.isWindowActive=!0;"None"===this._ongoingConnection?this.rejoinChat(this._rejoinArgs):this._log.error("resumeChat is called while ongoing connection is "+this._ongoingConnection+", hence ignoring.")};b.chat.ChatCustomerController.prototype.pendingDisconnect=function(){if(this._isChatPendingDisconnect)this._log.warn("pendingDisconnect has already been called");else{var a=this._chatId;this._isChatPendingDisconnect=
!0;this._chatClient.pendingDisconnect({chatId:a})}};b.chat.ChatCustomerController.prototype.resumeConversation=function(){var a=this._chatId;this._isChatPendingDisconnect&&(this._log.debug("resuming the conversation"),this._chatClient.resumeConversation({chatId:a}),this._isChatPendingDisconnect=!1)};b.chat.ChatCustomerController.prototype.endChat=function(a){a=a||{};var c=this._chatId,e=a.reason||b.chat.disconnectReasons.USER_DISCONNECT,d=a.onSuccess||function(){};a=a.onError||function(){};this._chatsExpectedToDisconnect[c]=
!0;this._chatClient.disconnect({chatId:c,reason:e,onSuccess:d,onError:a});this._log.info("Disconnected from chat")};b.chat.ChatCustomerController.prototype.endChatWithBeacon=function(a){if(this.options.isAsynchronousChat)this._log.info("Asynchronous chat cannot be disconnected");else{a=a||{};var c=this._chatId;a=a.reason||b.chat.disconnectReasons.USER_DISCONNECT;this._chatsExpectedToDisconnect[c]=!0;this._chatClient.disconnectWithBeacon({chatId:c,reason:a});this._log.info("Disconnected from chat with beacon request")}};
b.chat.ChatCustomerController.prototype.emailChatTranscript=function(a){var b=this;TelephonyUtil.validateParamIsNotMissing("args",a);TelephonyUtil.validateParamIsNotMissing("c2cId",a.c2cId);var e=a.onSuccess||function(){},d=a.onError||function(){};this._c2cClient.emailChatTranscript({chatIds:b._chatIdsHistory.join(","),c2cId:a.c2cId,transcriptToken:b._transcriptToken,locale:a.language,onError:function(){b._log.error("Transcript request failed for chatId - "+b._chatId);d()},onSuccess:function(){b._log.info("Transcript requested for chatId - "+
b._chatId);e()}})}})(h);(function(k){"undefined"==typeof b&&(b={});"undefined"==typeof b.chat&&(b.chat={});b.chat.TranscriptParsingUtility=function(e){this.options=k.extend({onParticipantChangeMessageReceived:function(a){},onParticipantMessageReceived:function(a){},onParticipantMetadataMessageReceived:function(a){},onParticipantAttachmentMessageReceived:function(a){},onBypassBotMessageReceived:function(a){},onTranscriptStart:function(){},onTranscriptEnd:function(){},onTranscriptEmpty:function(){},
renderInitialQuestion:!0},e);this._log=e.logger||b.cs.log.getLogger("transcript-parser");this._customerParticipantId=e.customerParticipantId||b.chat.LocalParticipantId};b.chat.TranscriptParsingUtility.parseTranscript=function(e,a){TelephonyUtil.validateParamIsNotMissing("parser",e);var c=null,f=!1,d=null;a&&a.length?(e._log.info("Processing "+a.length+" transcript messages."),e.options.onTranscriptStart(a),a.forEach(function(a){switch(a.action){case b.chat.Action.TRANSCRIPT_START:d=a.data.customerInfo.initialQuestion;
break;case b.chat.Action.MESSAGE:a={participantId:a.data.from,text:a.data.text,time:new Date(a.data.timestamp)};a.participantId===c&&(a.participantId=e._customerParticipantId);e.options.onParticipantMessageReceived(a);break;case b.chat.Action.METADATA:a={participantId:a.data.from,text:a.data.text,transcriptText:a.data.transcriptText,relatedData:a.data.relatedData,time:new Date(a.data.timestamp)};a.participantId===c&&(a.participantId=e._customerParticipantId);e.options.onParticipantMetadataMessageReceived(a);
break;case b.chat.Action.ATTACHMENT:a={participantId:a.data.from,id:a.id,name:a.name,size:a.size,time:new Date(a.data.timestamp)};a.participantId===c&&(a.participantId=e._customerParticipantId);e.options.onParticipantAttachmentMessageReceived(a);break;case b.chat.Action.PARTICIPANT_CHANGE:var h=k.extend({},a.data.participant);c||(c=a.data.participant.participantId);c===a.data.participant.participantId&&(h=k.extend(h,{participantId:e._customerParticipantId}));h.reconnected=a.data.reconnected;e.options.onParticipantChangeMessageReceived({participant:h,
time:new Date(a.data.timestamp)});!f&&e.options.renderInitialQuestion&&d&&(e.options.onParticipantMessageReceived({participantId:e._customerParticipantId,text:d,time:new Date(a.data.timestamp)}),f=!0);break;case b.chat.Action.BYPASS_BOT:a={participantId:a.data.from,time:new Date(a.data.timestamp)},a.participantId===c&&(a.participantId=e._customerParticipantId),e.options.onBypassBotMessageReceived(a)}}),e.options.onTranscriptEnd()):(e._log.error("No messages in the transcript",a),e.options.onTranscriptEmpty())}})(h)},
l=window.AmazonUIPageJS||window.P;l?l.when("jQuery","TelephonyC2CCommon","TelephonyUploadAttachment","RavenChatClient").execute(function(h){n(h);l.register("RavenCustomerChatJavaScript",function(){})}):n(window.jQuery)})();
/* ******** */
